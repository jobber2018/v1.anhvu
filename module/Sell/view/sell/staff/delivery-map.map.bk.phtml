<?php
use Sulde\Service\Common\Common;
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>NPP ANH V≈®</title>
    <meta name="viewport" content="width&#x3D;device-width,&#x20;initial-scale&#x3D;1.0">
    <meta http-equiv="X-UA-Compatible" content="IE&#x3D;edge">
    <!-- Le styles -->
    <link href="&#x2F;favicon.png" rel="shortcut&#x20;icon" type="image&#x2F;x-icon">

    <!-- CSS INCLUDE -->
    <link rel="stylesheet" type="text/css" id="theme" href="/joli/css/theme-default.css"/>

    <!-- START SCRIPTS -->
    <!-- START PLUGINS -->
    <script type="text/javascript" src="/joli/js/plugins/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="/joli/js/plugins/jquery/jquery-ui.min.js"></script>
    <script type="text/javascript" src="/joli/js/plugins/bootstrap/bootstrap.min.js"></script>
    <!-- END PLUGINS -->

    <!-- THIS PAGE PLUGINS -->
    <script type="text/javascript" src="/joli/js/plugins/mcustomscrollbar/jquery.mCustomScrollbar.min.js"></script>
    <!-- END PAGE PLUGINS -->

    <!-- START TEMPLATE -->
    <script type="text/javascript" src="/joli/js/plugins.js"></script>
    <script type="text/javascript" src="/joli/js/actions.js"></script>

    <link href="/vendor/jquery/waitMe/waitMe.css" rel="stylesheet">
    <script src="/vendor/jquery/waitMe/waitMe.js"></script>
    <script type="text/javascript" src="/js/admin.js"></script>
    <!-- END TEMPLATE -->
    <!-- END SCRIPTS -->

</head>
<body>
<div id="wrapper">
    <div id="header">
        <img src="/img/icons/icon-grocery-blue.png" width="25px"> <span> ƒêang giao</span> (<span id="blue"></span> ƒë∆°n)
    </div>
    <div id="map-canvas"></div>
</div>
</body>
</html>
<style>
    html, body, #wrapper{
        height: 100%;
        width: 100%;
    }
    #header{
        background-color:#ff6700;
        padding:5px;
        margin:10px;
        position: absolute;
        z-index: 1000;
    }
    #map-canvas{
        height: 100%;
        width: 100%;
    }
</style>
<?php
function getOptimizedRoute($start, $waypoints, $apiKey) {
    $waypoints[] = $start; // Th√™m ƒëi·ªÉm xu·∫•t ph√°t v√†o cu·ªëi ƒë·ªÉ t·∫°o v√≤ng tr√≤n

    // Chuy·ªÉn t·ªça ƒë·ªô th√†nh chu·ªói ƒë·ªãnh d·∫°ng Google Maps API
    $waypointsStr = implode('|', array_map(function ($wp) {
        return "{$wp['lat']},{$wp['lng']}";
    }, $waypoints));

    // G·ªçi Google Directions API v·ªõi ch·∫ø ƒë·ªô "driving"
    $url = "https://maps.googleapis.com/maps/api/directions/json?"
        . "origin={$start['lat']},{$start['lng']}"
        . "&destination={$start['lat']},{$start['lng']}"
        . "&waypoints=optimize:true|$waypointsStr"
        . "&mode=driving"  // üöó Ch·∫ø ƒë·ªô di chuy·ªÉn b·∫±ng √¥ t√¥
        . "&key=$apiKey";

    // G·ª≠i request API
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    $response = curl_exec($ch);
    curl_close($ch);

    return json_decode($response, true);
}

// üìå C·∫•u h√¨nh c√°c ƒëi·ªÉm v·ªõi latitude (lat) v√† longitude (lng)
$start = ['lat' => 20.93503664464731, 'lng' => 105.78945461301609];  // H√† N·ªôi
$waypoints=[];
$pointName=[];
if($this->sellOrder){

    foreach ($this->sellOrder as $sellOrderItem) {
        if(!is_null($sellOrderItem->getGrocery()->getLat()) && !is_null($sellOrderItem->getGrocery()->getLng())){
            $tmp['lat']=trim($sellOrderItem->getGrocery()->getLat());
            $tmp['lng']=trim($sellOrderItem->getGrocery()->getLng());
            $tmp['name']=trim($sellOrderItem->getGrocery()->getGroceryName());
            $tmp['id']=trim($sellOrderItem->getId());
//            $pointName[]=$sellOrderItem->getGrocery()->getGroceryName();
            $waypoints[]=$tmp;

        }
    }
}
$apiKey = "AIzaSyDChks5OL1rjm77PHapW76G0BWRdxIesxY"; // Thay b·∫±ng API Key c·ªßa b·∫°n

// G·ªçi h√†m l·∫•y tuy·∫øn ƒë∆∞·ªùng t·ªëi ∆∞u
$result = getOptimizedRoute($start, $waypoints, $apiKey);

// Truy·ªÅn d·ªØ li·ªáu sang JavaScript
$jsRoute = json_encode($result);
$jsApiKey = $apiKey;
?>
<script>
    const routeData = <?= $jsRoute ?>;
    const apiKey = "<?= $jsApiKey ?>";
    const locations = <?= json_encode($waypoints) ?>;

    let map, directionsService, directionsRenderer;
    function initMap() {
        map = new google.maps.Map(document.getElementById("map-canvas"), {
            zoom: 12,
            center: { lat: 20.93503664464731, lng: 105.78945461301609 },
        });

        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
            map: map,
            suppressMarkers: true // ·∫®n marker m·∫∑c ƒë·ªãnh c·ªßa Google
        });

        if (routeData.status === "OK") {
            directionsRenderer.setDirections(routeData);
            addMarkers(routeData);
        } else {
            alert("Kh√¥ng th·ªÉ hi·ªÉn th·ªã b·∫£n ƒë·ªì: " + routeData.status);
        }
         //calculateRoute("DRIVING"); // M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã ƒë∆∞·ªùng ƒëi √¥ t√¥

    }
    function calculateRoute(travelMode) {
        // Ki·ªÉm tra n·∫øu d·ªØ li·ªáu tuy·∫øn ƒë∆∞·ªùng kh√¥ng h·ª£p l·ªá
        if (routeData.status !== "OK") {
            alert("Kh√¥ng th·ªÉ t·∫£i tuy·∫øn ƒë∆∞·ªùng: " + routeData.status);
            return;
        }

        const legs = routeData.routes[0].legs;

        const waypoints = legs.slice(1, -1).map(leg => ({
            location: leg.start_location,
            stopover: true
        }));

        const request = {
            origin: legs[0].start_location,
            destination: legs[legs.length - 1].end_location,
            waypoints: waypoints,
            travelMode: google.maps.TravelMode[travelMode],
        };

        // G·ª≠i y√™u c·∫ßu ch·ªâ ƒë∆∞·ªùng t·ª´ Google Directions API
        directionsService.route(request, (response, status) => {
            if (status === "OK") {
                // V·∫Ω tuy·∫øn ƒë∆∞·ªùng tr√™n b·∫£n ƒë·ªì
                directionsRenderer.setDirections(response);
                addMarkers(response);  // Th√™m c√°c markers th·ªß c√¥ng
            } else {
                alert("L·ªói ch·ªâ ƒë∆∞·ªùng: " + status);
            }
        });
    }

    // H√†m th√™m markers v√†o b·∫£n ƒë·ªì v·ªõi s·ªë th·ª© t·ª±
    function addMarkers(response) {
        const legs = response.routes[0].legs;
        let markers = [];

        legs.forEach((leg, index) => {
            // L·∫•y v·ªã tr√≠ ƒëi·ªÉm hi·ªán t·∫°i
            const position = leg.start_location;
            const markerLabel = (index + 1).toString(); // ƒê√°nh s·ªë th·ª© t·ª±

            // T√¨m t√™n ƒë·ªãa ƒëi·ªÉm theo lat/lng
            const location = locations.find(loc =>
                Math.abs(loc.lat - position.lat) < 0.0001 &&
                Math.abs(loc.lng - position.lng) < 0.0001
            );

            const locationName = location ? location.name : `ƒêi·ªÉm ${markerLabel}`;

            // T·∫°o marker
            const marker = new google.maps.Marker({
                position: position,
                map: map,
                label: markerLabel,
            });

            // Th√™m InfoWindow khi click v√†o marker
            const infoWindow = new google.maps.InfoWindow({
                content: `<strong>${locationName}</strong><br>${leg.start_address}`,
            });

            marker.addListener('click', () => {
                infoWindow.open(map, marker);
            });

            markers.push(marker);
        });

        // Th√™m marker cho ƒëi·ªÉm cu·ªëi
        const lastLeg = legs[legs.length - 1];
        const lastPosition = lastLeg.end_location;
        const lastMarkerLabel = (legs.length + 1).toString();

        const lastLocation = locations.find(loc =>
            Math.abs(loc.lat - lastPosition.lat) < 0.0001 &&
            Math.abs(loc.lng - lastPosition.lng) < 0.0001
        );

        const lastLocationName = lastLocation ? lastLocation.name : `ƒêi·ªÉm ${lastMarkerLabel}`;

        const lastMarker = new google.maps.Marker({
            position: lastPosition,
            map: map,
            label: lastMarkerLabel,
        });

        const lastInfoWindow = new google.maps.InfoWindow({
            content: `<strong>${lastLocationName}</strong>`,
        });

        lastMarker.addListener('click', () => {
            lastInfoWindow.open(map, lastMarker);
        });

        markers.push(lastMarker);
    }

    function getInfoMarket(position){
        console.log(position.lat+';'+position.lng);

        const location = locations.find(loc =>
            Math.abs(loc.lat - position.lat) < 0.0001 &&
            Math.abs(loc.lng - position.lng) < 0.0001
        );

        if(location){
            console.log(location.name);
        }

        return location;
        /*locations.forEach((location, index) => {
            console.log(location.lat+';'+location.lng)
        });*/
    }
</script>

<!-- Google Maps API JS -->
<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=<?= $jsApiKey ?>&callback=initMap">
</script>
